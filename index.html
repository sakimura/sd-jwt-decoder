<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SD-JWT Decoder with Verification</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import jose library for JWT verification
        import * as jose from 'https://cdn.jsdelivr.net/npm/jose@5.2.0/+esm';
        window.jose = jose;
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide React icons as simple SVG components
        const AlertCircle = ({ className, size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );

        const CheckCircle = ({ className, size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        );

        const Copy = ({ className, size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        );

        const Info = ({ className, size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        );

        const XCircle = ({ className, size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
        );

        const Shield = ({ className, size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
        );

        const SDJWTDecoder = () => {
            const [input, setInput] = useState('');
            const [publicKeyInput, setPublicKeyInput] = useState('');
            const [decoded, setDecoded] = useState(null);
            const [error, setError] = useState('');
            const [copied, setCopied] = useState(false);
            const [verificationStatus, setVerificationStatus] = useState(null);
            const [verifying, setVerifying] = useState(false);

            const base64UrlDecode = (str) => {
                let base64 = str.replace(/-/g, '+').replace(/_/g, '/');
                while (base64.length % 4) {
                    base64 += '=';
                }
                try {
                    return JSON.parse(atob(base64));
                } catch (e) {
                    return atob(base64);
                }
            };
            // --- SD-JWT _sd digest verification helpers (sha-256) ---
            const base64UrlToBytes = (b64url) => {
                const pad = "=".repeat((4 - (b64url.length % 4)) % 4);
                const b64 = (b64url.replace(/-/g, "+").replace(/_/g, "/") + pad);
                const str = atob(b64);
                const bytes = new Uint8Array(str.length);
                for (let i = 0; i < str.length; i++) bytes[i] = str.charCodeAt(i);
                return bytes;
            };
            const bytesToBase64Url = (bytes) => {
                let bin = "";
                bytes.forEach(b => bin += String.fromCharCode(b));
                return btoa(bin).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
            };
            const sha256B64Url = async (bytes) => {
                if (!crypto?.subtle) throw new Error("Web Crypto SubtleCrypto unavailable (use HTTPS or localhost).");
                const digest = await crypto.subtle.digest("SHA-256", bytes);
                return bytesToBase64Url(new Uint8Array(digest));
            };
            
            const digestDisclosureB64Url = async (disclosureB64Url) => {
                // Per SD-JWT spec, the digest is computed over the BASE64URL disclosure string bytes (UTF-8),
                // not the decoded JSON bytes.
                const bytes = new TextEncoder().encode(disclosureB64Url);
                return sha256B64Url(bytes);
            };

            const verifySdListAgainstDisclosures = async (payload, disclosureStrings) => {
                const sdAlg = (payload?._sd_alg || "sha-256").toLowerCase();
                if (sdAlg !== "sha-256") {
                    return { ok: false, alg: sdAlg, reason: "Unsupported _sd_alg", matches: [], missing: [], extra: payload?._sd || [] };
                }
                const sdList = Array.isArray(payload?._sd) ? payload._sd : [];
                const computed = await Promise.all(
                    disclosureStrings.map(async (d) => ({ disclosure: d, digest: await digestDisclosureB64Url(d) }))
                );
                const matches = [];
                const missing = [];
                for (const c of computed) {
                    if (sdList.includes(c.digest)) matches.push(c);
                    else missing.push(c);
                }
                const computedDigests = new Set(computed.map(c => c.digest));
                const extra = sdList.filter(d => !computedDigests.has(d));
                const ok = missing.length === 0;
                return { ok, alg: sdAlg, matches, missing, extra, totalSd: sdList.length, disclosed: computed.length };
            };


            const verifySignature = async (jwtString, publicKeyJwk) => {
                try {
                    setVerifying(true);
                    setVerificationStatus(null);

                    if (!window.jose) {
                        throw new Error('JOSE library not loaded yet. Please wait and try again.');
                    }

                    // Parse the JWT header to get the algorithm
                    const jwtParts = jwtString.split('.');
                    const headerBase64 = jwtParts[0];
                    const header = base64UrlDecode(headerBase64);
                    const algorithm = header.alg;

                    // Parse the public key (remove any newlines first)
                    let jwk;
                    if (typeof publicKeyJwk === 'string') {
                        const cleanedKey = publicKeyJwk.replace(/[\r\n]/g, '');
                        jwk = JSON.parse(cleanedKey);
                    } else {
                        jwk = publicKeyJwk;
                    }

                    // Import the public key
                    const publicKey = await window.jose.importJWK(jwk, algorithm);

                    // Verify the JWT with explicit algorithm
                    const { payload, protectedHeader } = await window.jose.jwtVerify(jwtString, publicKey, {
                        algorithms: [algorithm]
                    });

                    setVerificationStatus({
                        success: true,
                        message: 'Verification succeeded',
                        algorithm: protectedHeader.alg
                    });

                } catch (err) {
                    console.error('Verification error:', err);
                    setVerificationStatus({
                        success: false,
                        message: 'Verification failed',
                        error: err.message
                    });
                } finally {
                    setVerifying(false);
                }
            };

            const decodeSDJWT = async (sdJwt) => {
                try {
                    setError('');
                    setVerificationStatus(null);
                    
                    // Remove all newlines and whitespace to handle multi-line input from spec documents
                    const cleanedSdJwt = sdJwt.replace(/[\r\n\s]/g, '');
                    
                    const parts = cleanedSdJwt.trim().split('~');
                    
                    if (parts.length < 1) {
                        throw new Error('Invalid SD-JWT format');
                    }

                    const jwtString = parts[0];
                    const jwtParts = jwtString.split('.');
                    if (jwtParts.length !== 3) {
                        throw new Error('Invalid JWT format');
                    }

                    const header = base64UrlDecode(jwtParts[0]);
                    const payload = base64UrlDecode(jwtParts[1]);
                    const signature = jwtParts[2];

                    const disclosures = [];
                    let kbJwt = null;

                    for (let i = 1; i < parts.length; i++) {
                        const part = parts[i].trim();
                        if (!part) continue;

                        if (part.includes('.') && part.split('.').length === 3) {
                            const kbParts = part.split('.');
                            kbJwt = {
                                header: base64UrlDecode(kbParts[0]),
                                payload: base64UrlDecode(kbParts[1]),
                                signature: kbParts[2]
                            };
                        } else {
                            try {
                                const disclosure = base64UrlDecode(part);
                                disclosures.push({
                                    raw: part,
                                    decoded: disclosure
                                });
                            } catch (e) {
                                console.warn('Failed to decode disclosure:', part);
                            }
                        }
                    }

                    const reconstructedClaims = JSON.parse(JSON.stringify(payload));
                    
                    disclosures.forEach(disc => {
                        if (Array.isArray(disc.decoded) && disc.decoded.length >= 2) {
                            const [salt, claimName, claimValue] = disc.decoded;
                            if (claimName && claimValue !== undefined) {
                                reconstructedClaims[claimName] = claimValue;
                            }
                        }
                    });

                    const cleanedClaims = { ...reconstructedClaims };
                    delete cleanedClaims._sd;
                    delete cleanedClaims._sd_alg;


                    // Verify _sd digest list against disclosures (hash-binding)
                    let sdVerification = null;
                    try {
                        const disclosureStrings = disclosures.map(d => d.raw);
                        sdVerification = await verifySdListAgainstDisclosures(payload, disclosureStrings);
                    } catch (e) {
                        sdVerification = { ok: false, error: e.message };
                    }
                    setDecoded({
                        jwt: {
                            header,
                            payload,
                            signature
                        },
                        jwtString,
                        disclosures,
                        kbJwt,
                        reconstructedClaims: cleanedClaims,
                        originalPayload: payload,
                        sdVerification
                    });

                    // Perform verification if public key is provided
                    if (publicKeyInput.trim()) {
                        await verifySignature(jwtString, publicKeyInput);
                    }

                } catch (err) {
                    setError(err.message);
                    setDecoded(null);
                }
            };

            const handleDecode = () => {
                if (!input.trim()) {
                    setError('Please enter an SD-JWT');
                    return;
                }
                decodeSDJWT(input);
            };

            const handleVerify = async () => {
                if (!decoded) {
                    setError('Please decode an SD-JWT first');
                    return;
                }
                if (!publicKeyInput.trim()) {
                    setError('Please provide a public key');
                    return;
                }
                await verifySignature(decoded.jwtString, publicKeyInput);
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(JSON.stringify(text, null, 2));
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            // Store example with newlines as in the spec, will be cleaned when loaded
            const exampleSDJWT = `eyJhbGciOiAiRVMyNTYiLCAidHlwIjogImV4YW1wbGUrc2Qtand0In0.eyJfc2QiOiBbIkNyUWU3UzVrcUJBSHQtbk1ZWGdjNmJkdDJTSDVhVFkxc1VfTS1QZ2tqUEkiLCAiSnpZakg0c3ZsaUgwUjNQeUVNZmVadTZKdDY5dTVxZWhabzdGN0VQWWxTRSIsICJQb3JGYnBLdVZ1Nnh5bUphZ3ZrRnNGWEFiUm9jMkpHbEFVQTJCQTRvN2NJIiwgIlRHZjRvTGJnd2Q1SlFhSHlLVlFaVTlVZEdFMHc1cnREc3JaemZVYW9tTG8iLCAiWFFfM2tQS3QxWHlYN0tBTmtxVlI2eVoyVmE1TnJQSXZQWWJ5TXZSS0JNTSIsICJYekZyendzY002R242Q0pEYzZ2Vks4QmtNbmZHOHZPU0tmcFBJWmRBZmRFIiwgImdiT3NJNEVkcTJ4Mkt3LXc1d1BFemFrb2I5aFYxY1JEMEFUTjNvUUw5Sk0iLCAianN1OXlWdWx3UVFsaEZsTV8zSmx6TWFTRnpnbGhRRzBEcGZheVF3TFVLNCJdLCAiaXNzIjogImh0dHBzOi8vaXNzdWVyLmV4YW1wbGUuY29tIiwgImlhdCI6IDE2ODMwMDAwMDAsICJleHAiOiAxODgzMDAwMDAwLCAic3ViIjogInVzZXJfNDIiLCAibmF0aW9uYWxpdGllcyI6IFt7Ii4uLiI6ICJwRm5kamtaX1ZDem15VGE2VWpsWm8zZGgta284YUlLUWM5RGxHemhhVllvIn0sIHsiLi4uIjogIjdDZjZKa1B1ZHJ5M2xjYndIZ2VaOGtoQXYxVTFPU2xlclAwVmtCSnJXWjAifV0sICJfc2RfYWxnIjogInNoYS0yNTYiLCAiY25mIjogeyJqd2siOiB7Imt0eSI6ICJFQyIsICJjcnYiOiAiUC0yNTYiLCAieCI6ICJUQ0FFUjE5WnZ1M09IRjRqNFc0dmZTVm9ISVAxSUxpbERsczd2Q2VHZW1jIiwgInkiOiAiWnhqaVdXYlpNUUdIVldLVlE0aGJTSWlyc1ZmdWVjQ0U2dDRqVDlGMkhaUSJ9fX0.MczwjBFGtzf-6WMT-hIvYbkb11NrV1WMO-jTijpMPNbswNzZ87wY2uHz-CXo6R04b7jYrpj9mNRAvVssXou1iw~WyIyR0xDNDJzS1F2ZUNmR2ZyeU5STjl3IiwgImdpdmVuX25hbWUiLCAiSm9obiJd~WyJlbHVWNU9nM2dTTklJOEVZbnN4QV9BIiwgImZhbWlseV9uYW1lIiwgIkRvZSJd~WyI2SWo3dE0tYTVpVlBHYm9TNXRtdlZBIiwgImVtYWlsIiwgImpvaG5kb2VAZXhhbXBsZS5jb20iXQ~WyJlSThaV205UW5LUHBOUGVOZW5IZGhRIiwgInBob25lX251bWJlciIsICIrMS0yMDItNTU1LTAxMDEiXQ~WyJRZ19PNjR6cUF4ZTQxMmExMDhpcm9BIiwgInBob25lX251bWJlcl92ZXJpZmllZCIsIHRydWVd~WyJBSngtMDk1VlBycFR0TjRRTU9xUk9BIiwgImFkZHJlc3MiLCB7InN0cmVldF9hZGRyZXNzIjogIjEyMyBNYWluIFN0IiwgImxvY2FsaXR5IjogIkFueXRvd24iLCAicmVnaW9uIjogIkFueXN0YXRlIiwgImNvdW50cnkiOiAiVVMifV0~WyJQYzMzSk0yTGNoY1VfbEhnZ3ZfdWZRIiwgImJpcnRoZGF0ZSIsICIxOTQwLTAxLTAxIl0~WyJHMDJOU3JRZmpGWFE3SW8wOXN5YWpBIiwgInVwZGF0ZWRfYXQiLCAxNTcwMDAwMDAwXQ~WyJsa2x4RjVqTVlsR1RQVW92TU5JdkNBIiwgIlVTIl0~WyJuUHVvUW5rUkZxM0JJZUFtN0FuWEZBIiwgIkRFIl0~`;

            const examplePublicKey = `{
  "kty": "EC",
  "crv": "P-256",
  "x": "b28d4MwZMjw8-00CG4xfnn9SLMVMM19SlqZpVb_uNtQ",
  "y": "Xv5zWwuoaTgdS6hV43yI6gBwTnjukmFQQnJ_kCxzqk8"
}`;

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-lg shadow-xl p-8 mb-6">
                            <div className="flex items-center gap-3 mb-6">
                                <div className="bg-indigo-600 p-3 rounded-lg">
                                    <Info className="text-white" size={28} />
                                </div>
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-800">SD-JWT Decoder with Verification</h1>
                                    <p className="text-gray-600">Decode and verify Selective Disclosure JSON Web Tokens</p>
                                </div>
                            </div>

                            <div className="mb-4">
                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-sm font-medium text-gray-700">
                                        SD-JWT Input
                                    </label>
                                    <button
                                        onClick={() => {
                                            setInput(exampleSDJWT);
                                            setPublicKeyInput(examplePublicKey);
                                        }}
                                        className="text-sm text-indigo-600 hover:text-indigo-800"
                                    >
                                        Load Example
                                    </button>
                                </div>
                                <textarea
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    placeholder="Paste your SD-JWT here (format: jwt~disclosure1~disclosure2~...)"
                                    className="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm"
                                />
                            </div>

                            <div className="mb-4">
                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-sm font-medium text-gray-700">
                                        Issuer Public Key (JWK format - optional)
                                    </label>
                                    <button
                                        onClick={() => setPublicKeyInput(examplePublicKey)}
                                        className="text-sm text-indigo-600 hover:text-indigo-800"
                                    >
                                        Load Example Key
                                    </button>
                                </div>
                                <textarea
                                    value={publicKeyInput}
                                    onChange={(e) => setPublicKeyInput(e.target.value)}
                                    placeholder='{"kty": "EC", "crv": "P-256", "x": "...", "y": "..."}'
                                    className="w-full h-24 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm"
                                />
                                <p className="text-xs text-gray-500 mt-1">
                                    Example from IETF OAuth SD-JWT Draft Specification
                                </p>
                            </div>

                            <button
                                onClick={handleDecode}
                                className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors mb-2"
                            >
                                Decode SD-JWT
                            </button>

                            {decoded && publicKeyInput.trim() && (
                                <button
                                    onClick={handleVerify}
                                    disabled={verifying}
                                    className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors disabled:bg-gray-400"
                                >
                                    {verifying ? 'Verifying...' : 'Verify Signature'}
                                </button>
                            )}

                            {error && (
                                <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-2">
                                    <AlertCircle className="text-red-500 flex-shrink-0 mt-0.5" size={20} />
                                    <div>
                                        <p className="font-semibold text-red-800">Error</p>
                                        <p className="text-red-600 text-sm">{error}</p>
                                    </div>
                                </div>
                            )}

                            {decoded && !publicKeyInput.trim() && (
                                <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg flex items-start gap-2">
                                    <AlertCircle className="text-yellow-600 flex-shrink-0 mt-0.5" size={20} />
                                    <div>
                                        <p className="font-semibold text-yellow-800">Verification Info</p>
                                        <p className="text-yellow-700 text-sm">To perform verification, please provide the issuer's public key</p>
                                    </div>
                                </div>
                            )}

                            {verificationStatus && (
                                <div className={`mt-4 p-4 rounded-lg border-2 flex items-start gap-2 ${
                                    verificationStatus.success 
                                        ? 'bg-green-50 border-green-300' 
                                        : 'bg-red-50 border-red-300'
                                }`}>
                                    {verificationStatus.success ? (
                                        <CheckCircle className="text-green-600 flex-shrink-0 mt-0.5" size={24} />
                                    ) : (
                                        <XCircle className="text-red-600 flex-shrink-0 mt-0.5" size={24} />
                                    )}
                                    <div className="flex-1">
                                        <p className={`font-bold text-lg ${
                                            verificationStatus.success ? 'text-green-800' : 'text-red-800'
                                        }`}>
                                            {verificationStatus.message}
                                        </p>
                                        {verificationStatus.success && (
                                            <p className="text-green-700 text-sm mt-1">
                                                Algorithm: {verificationStatus.algorithm}
                                            </p>
                                        )}
                                        {!verificationStatus.success && verificationStatus.error && (
                                            <p className="text-red-600 text-sm mt-1">
                                                {verificationStatus.error}
                                            </p>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        {decoded && (
                            <div className="space-y-6">
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                            <Shield className="text-indigo-600" size={24} />
                                            JWT Header
                                        </h2>
                                        <button
                                            onClick={() => copyToClipboard(decoded.jwt.header)}
                                            className="text-indigo-600 hover:text-indigo-800 flex items-center gap-1"
                                        >
                                            <Copy size={18} />
                                            {copied ? 'Copied!' : 'Copy'}
                                        </button>
                                    </div>
                                    <pre className="bg-gray-50 p-4 rounded-lg overflow-x-auto text-sm">
                                        {JSON.stringify(decoded.jwt.header, null, 2)}
                                    </pre>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-bold text-gray-800">JWT Payload (Original)</h2>
                                        <button
                                            onClick={() => copyToClipboard(decoded.originalPayload)}
                                            className="text-indigo-600 hover:text-indigo-800 flex items-center gap-1"
                                        >
                                            <Copy size={18} />
                                            {copied ? 'Copied!' : 'Copy'}
                                        </button>
                                    </div>
                                    <pre className="bg-gray-50 p-4 rounded-lg overflow-x-auto text-sm">
                                        {JSON.stringify(decoded.originalPayload, null, 2)}
                                    </pre>
                                </div>

                                {decoded.disclosures.length > 0 && (
                                    <div className="bg-white rounded-lg shadow-lg p-6">
                                        <h2 className="text-xl font-bold text-gray-800 mb-4">
                                            Disclosures ({decoded.disclosures.length})
                                        </h2>
                                        <div className="space-y-4">
                                            {decoded.disclosures.map((disc, idx) => (
                                                <div key={idx} className="border border-gray-200 rounded-lg p-4">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <h3 className="font-semibold text-gray-700">Disclosure {idx + 1}</h3>
                                                        <button
                                                            onClick={() => copyToClipboard(disc.decoded)}
                                                            className="text-indigo-600 hover:text-indigo-800 text-sm flex items-center gap-1"
                                                        >
                                                            <Copy size={16} />
                                                        </button>
                                                    </div>
                                                    <div className="mb-2">
                                                        <p className="text-xs text-gray-500 mb-1">Base64URL:</p>
                                                        <p className="text-xs font-mono bg-gray-50 p-2 rounded break-all">
                                                            {disc.raw}
                                                        </p>
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-gray-500 mb-1">Decoded:</p>
                                                        <pre className="text-sm bg-indigo-50 p-3 rounded overflow-x-auto">
                                                            {JSON.stringify(disc.decoded, null, 2)}
                                                        </pre>
                                                    </div>
                                                    {Array.isArray(disc.decoded) && disc.decoded.length >= 3 && (
                                                        <div className="mt-2 text-sm text-gray-600">
                                                            <span className="font-semibold">Claim:</span> {disc.decoded[1]} ={' '}
                                                            {JSON.stringify(disc.decoded[2])}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                
                                {/* SD Digest Verification */}
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center gap-2 mb-3">
                                        <Shield className={decoded?.sdVerification?.ok ? "text-green-600" : "text-red-600"} size={22} />
                                        <h2 className="text-lg font-semibold text-gray-800">SD Digest Verification</h2>
                                    </div>
                                    {!decoded?.sdVerification && (
                                        <p className="text-sm text-gray-600">No verification run yet.</p>
                                    )}
                                    {decoded?.sdVerification && (
                                        <>
                                            {decoded.sdVerification.error ? (
                                                <p className="text-sm text-red-600">Error: {decoded.sdVerification.error}</p>
                                            ) : (
                                                <>
                                                    <p className="text-sm">
                                                        <span className="font-medium">Algorithm:</span> {decoded.sdVerification.alg || "sha-256"}
                                                    </p>
                                                    <p className={decoded.sdVerification.ok ? "mt-1 text-sm text-green-700" : "mt-1 text-sm text-red-700"}>
                                                        {decoded.sdVerification.ok
                                                            ? "All provided disclosures are present in the payload’s _sd list."
                                                            : "Some provided disclosures are NOT present in the payload’s _sd list."}
                                                    </p>
                                                    <div className="grid md:grid-cols-3 gap-4 mt-4 text-sm">
                                                        <div className="border rounded p-3">
                                                            <div className="font-medium mb-1">Summary</div>
                                                            <ul className="list-disc list-inside text-gray-700">
                                                                <li>_sd entries in payload: {decoded.sdVerification.totalSd ?? "—"}</li>
                                                                <li>Disclosures provided: {decoded.sdVerification.disclosed ?? "—"}</li>
                                                                <li>Matched: {decoded.sdVerification.matches?.length ?? 0}</li>
                                                                <li>Missing: {decoded.sdVerification.missing?.length ?? 0}</li>
                                                                <li>Extra (undisclosed yet in _sd): {decoded.sdVerification.extra?.length ?? 0}</li>
                                                            </ul>
                                                        </div>
                                                        <div className="border rounded p-3">
                                                            <div className="font-medium mb-1">Missing (not found in _sd)</div>
                                                            <ol className="space-y-1 text-gray-700">
                                                                {decoded.sdVerification.missing?.length
                                                                    ? decoded.sdVerification.missing.map((m, i) => (
                                                                        <li key={i} className="break-all font-mono">{m.digest}</li>
                                                                    ))
                                                                    : <li className="text-gray-500">None</li>}
                                                            </ol>
                                                        </div>
                                                        <div className="border rounded p-3">
                                                            <div className="font-medium mb-1">Extra (in _sd but undisclosed)</div>
                                                            <ol className="space-y-1 text-gray-700">
                                                                {decoded.sdVerification.extra?.length
                                                                    ? decoded.sdVerification.extra.map((d, i) => (
                                                                        <li key={i} className="break-all font-mono">{d}</li>
                                                                    ))
                                                                    : <li className="text-gray-500">None</li>}
                                                            </ol>
                                                        </div>
                                                    </div>
                                                </>
                                            )}
                                        </>
                                    )}
                                </div>
<div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg shadow-lg p-6 border-2 border-green-200">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                            <CheckCircle className="text-green-600" size={24} />
                                            Reconstructed Claims
                                        </h2>
                                        <button
                                            onClick={() => copyToClipboard(decoded.reconstructedClaims)}
                                            className="text-green-600 hover:text-green-800 flex items-center gap-1"
                                        >
                                            <Copy size={18} />
                                            {copied ? 'Copied!' : 'Copy'}
                                        </button>
                                    </div>
                                    <p className="text-sm text-gray-600 mb-3">
                                        Complete claims with all disclosures applied
                                    </p>
                                    <pre className="bg-white p-4 rounded-lg overflow-x-auto text-sm border border-green-200">
                                        {JSON.stringify(decoded.reconstructedClaims, null, 2)}
                                    </pre>
                                </div>

                                {decoded.kbJwt && (
                                    <div className="bg-white rounded-lg shadow-lg p-6">
                                        <h2 className="text-xl font-bold text-gray-800 mb-4">
                                            Key Binding JWT (KB-JWT)
                                        </h2>
                                        <div className="space-y-3">
                                            <div>
                                                <h3 className="font-semibold text-gray-700 mb-2">Header</h3>
                                                <pre className="bg-gray-50 p-3 rounded-lg overflow-x-auto text-sm">
                                                    {JSON.stringify(decoded.kbJwt.header, null, 2)}
                                                </pre>
                                            </div>
                                            <div>
                                                <h3 className="font-semibold text-gray-700 mb-2">Payload</h3>
                                                <pre className="bg-gray-50 p-3 rounded-lg overflow-x-auto text-sm">
                                                    {JSON.stringify(decoded.kbJwt.payload, null, 2)}
                                                </pre>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-bold text-gray-800 mb-4">JWT Signature</h2>
                                    <p className="font-mono text-sm bg-gray-50 p-4 rounded-lg break-all">
                                        {decoded.jwt.signature}
                                    </p>
                                </div>
                            </div>
                        )}

                        <div className="mt-8 bg-blue-50 rounded-lg p-6 border border-blue-200">
                            <h3 className="font-semibold text-blue-900 mb-2">About SD-JWT</h3>
                            <p className="text-sm text-blue-800 mb-3">
                                Selective Disclosure JWT (SD-JWT) is a specification that extends JSON Web Tokens to enable 
                                selective disclosure of claims. The format consists of a JWT followed by base64url-encoded 
                                disclosures separated by tildes (~). Each disclosure reveals specific claims that were hashed 
                                in the original JWT payload.
                            </p>
                            <h3 className="font-semibold text-blue-900 mb-2 mt-4">Signature Verification</h3>
                            <p className="text-sm text-blue-800 mb-3">
                                To verify the authenticity of an SD-JWT, provide the issuer's public key in JWK format. 
                                The verification process checks if the signature was created using the corresponding private key, 
                                ensuring the token hasn't been tampered with.
                            </p>
                            <h3 className="font-semibold text-blue-900 mb-2 mt-4">Example Data</h3>
                            <p className="text-sm text-blue-800">
                                The example SD-JWT and public key are from the{' '}
                                <a 
                                    href="https://www.ietf.org/archive/id/draft-ietf-oauth-selective-disclosure-jwt-22.html" 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="underline hover:text-blue-900"
                                >
                                    IETF OAuth Selective Disclosure JWT Draft Specification
                                </a>
                                . The decoder automatically removes newlines from input, making it easy to copy examples directly from the specification.
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // Wait for JOSE library to load
        const waitForJose = setInterval(() => {
            if (window.jose) {
                clearInterval(waitForJose);
                ReactDOM.render(<SDJWTDecoder />, document.getElementById('root'));
            }
        }, 100);

        // Fallback timeout
        setTimeout(() => {
            clearInterval(waitForJose);
            if (window.jose) {
                ReactDOM.render(<SDJWTDecoder />, document.getElementById('root'));
            } else {
                document.getElementById('root').innerHTML = '<div class="p-8 text-center text-red-600">Error loading required libraries. Please refresh the page.</div>';
            }
        }, 5000);
    </script>
</body>
</html>
